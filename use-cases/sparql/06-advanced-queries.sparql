#################################################################
# SECTION 6: ADVANCED ANALYTICAL QUERIES
#################################################################

PREFIX ex: <https://w3id.org/miao/ex#>
PREFIX miao: <https://w3id.org/miao#>
PREFIX prov: <http://www.w3.org/ns/prov#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX mls: <http://www.w3.org/ns/mls#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Query 6.1: Find samples where multimodal improved severity prediction
# Purpose: Quantify benefit of multimodal fusion
SELECT ?sample 
       ?textSeverity ?textConfidence
       ?multiSeverity ?multiConfidence
       (?multiConfidence - ?textConfidence AS ?confidenceImprovement)
WHERE {
  # Text-only prediction
  ?textRun miao:hasInputData ex2:SocialMediaText ;
           prov:generated ?textSet .
  ?textSet miao:hasMentalIllness ?textIllness .
  ?textIllness a ex2:Depression ;
               miao:referredToMentalIllnessCategory ?textSeverity ;
               miao:hasMentalIllnessDetectionConfidence ?textConfidence ;
               miao:refersToSample ?baseSample .
  
  # Multimodal prediction
  ?multiRun miao:hasInputData ex2:SocialMediaText, ex2:WearableSensors ;
            prov:generated ?multiSet .
  ?multiSet miao:hasMentalIllness ?multiIllness .
  ?multiIllness a ex2:Depression ;
                miao:referredToMentalIllnessCategory ?multiSeverity ;
                miao:hasMentalIllnessDetectionConfidence ?multiConfidence ;
                miao:refersToSample ?sample .
  
  FILTER(STRSTARTS(?sample, ?baseSample))
  FILTER(?multiConfidence > ?textConfidence)
}
ORDER BY DESC(?confidenceImprovement)

# Query 6.2: Identify low-confidence predictions needing review
# Purpose: Quality control for uncertain predictions
SELECT ?sample ?illness ?category ?confidence ?detectionMethod ?date
WHERE {
  ?detection prov:generated ?illnessSet ;
             dcterms:created ?date .
  
  ?illnessSet miao:hasMentalIllness ?illness .
  
  ?illness miao:referredToMentalIllnessCategory ?category ;
           miao:hasMentalIllnessDetectionConfidence ?confidence ;
           miao:refersToSample ?sample .
  
  OPTIONAL { ?detection mls:executes ?detectionMethod }
  
  FILTER(?confidence >= 0.50 && ?confidence < 0.70)
}
ORDER BY ?confidence

# Query 6.3: Schema interoperability - map categories across frameworks
# Purpose: Find equivalent or related categories across schemas
SELECT DISTINCT ?schema1 ?category1 ?schema2 ?category2 ?sharedSample
WHERE {
  ?illness1 miao:referredToMentalIllnessCategory ?category1 ;
            miao:refersToSample ?sharedSample .
  
  ?illness2 miao:referredToMentalIllnessCategory ?category2 ;
            miao:refersToSample ?sharedSample .
  
  ?category1 miao:isMentalIllnessCategoryOf ?schema1 .
  ?category2 miao:isMentalIllnessCategoryOf ?schema2 .
  
  FILTER(?schema1 != ?schema2)
  FILTER(?category1 != ?category2)
}

# Query 6.4: Expert agreement analysis
# Purpose: Calculate inter-annotator agreement
SELECT ?sample 
       (COUNT(DISTINCT ?category) AS ?uniqueCategories)
       (COUNT(?illness) AS ?totalAnnotations)
WHERE {
  ?detection a miao:ManualMentalIllnessesDetection ;
             prov:generated ?illnessSet .
  
  ?illnessSet miao:hasMentalIllness ?illness .
  
  ?illness miao:referredToMentalIllnessCategory ?category ;
           miao:refersToSample ?sample .
}
GROUP BY ?sample
HAVING(?totalAnnotations > 1)

# Query 6.5: Identify samples suitable for model training
# Purpose: Select high-quality annotated data for ML
SELECT ?sample ?category ?confidence ?annotatorCount
WHERE {
  {
    SELECT ?sample ?category (COUNT(DISTINCT ?detection) AS ?annotatorCount)
    WHERE {
      ?detection a miao:ManualMentalIllnessesDetection ;
                 prov:generated ?illnessSet .
      ?illnessSet miao:hasMentalIllness ?illness .
      ?illness miao:referredToMentalIllnessCategory ?category ;
               miao:refersToSample ?sample .
    }
    GROUP BY ?sample ?category
  }
  
  ?illness2 miao:referredToMentalIllnessCategory ?category ;
            miao:hasMentalIllnessDetectionConfidence ?confidence ;
            miao:refersToSample ?sample .
  
  FILTER(?confidence >= 0.85 && ?annotatorCount >= 2)
}

# Query 6.6: Full provenance chain for a prediction
# Purpose: Complete audit trail from data to result
SELECT ?sample ?detection ?agent ?inputData ?schema ?model ?evaluation ?illness ?category
WHERE {
  ?detection prov:generated ?illnessSet ;
             miao:hasInputData ?inputData ;
             miao:usedMentalIllnessesSchema ?schema .
  
  ?illnessSet miao:hasMentalIllness ?illness .
  ?illness miao:referredToMentalIllnessCategory ?category ;
           miao:refersToSample ?sample .
  
  OPTIONAL { ?detection prov:wasAssociatedWith ?agent }
  OPTIONAL { 
    ?detection mls:executes ?model ;
               mls:hasOutput ?evaluation .
  }
  
  FILTER(?sample = "socialmedia_000001")
}