#################################################################
# SECTION 5: STATISTICAL AND AGGREGATE QUERIES
#################################################################

PREFIX ex: <https://w3id.org/miao/ex#>
PREFIX miao: <https://w3id.org/miao#>
PREFIX prov: <http://www.w3.org/ns/prov#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX mls: <http://www.w3.org/ns/mls#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Query 5.1: Distribution of severity levels across all predictions
# Purpose: Statistical overview of detected severity
SELECT ?severityCategory ?categoryTitle (COUNT(?illness) AS ?count)
WHERE {
  ?illness miao:referredToMentalIllnessCategory ?severityCategory ;
           miao:hasMentalIllnessLevel ?level .
  
  ?severityCategory dcterms:title ?categoryTitle ;
                    miao:isMentalIllnessCategoryOf ex:DepressionSeveritySchema_Research .
}
GROUP BY ?severityCategory ?categoryTitle
ORDER BY ?categoryTitle

# Query 5.2: Average confidence by detection method
# Purpose: Compare confidence levels between manual and automatic
SELECT ?detectionType (AVG(?confidence) AS ?avgConfidence) (COUNT(?illness) AS ?count)
WHERE {
  ?detection prov:generated ?illnessSet .
  ?illnessSet miao:hasMentalIllness ?illness .
  ?illness miao:hasMentalIllnessDetectionConfidence ?confidence .
  
  BIND(IF(EXISTS { ?detection a miao:ManualMentalIllnessesDetection }, 
          "Manual", "Automatic") AS ?detectionType)
}
GROUP BY ?detectionType

# Query 5.3: Most frequently detected categories
# Purpose: Identify most common diagnoses in dataset
SELECT ?category ?categoryTitle (COUNT(?illness) AS ?detectionCount)
WHERE {
  ?illness miao:referredToMentalIllnessCategory ?category .
  ?category dcterms:title ?categoryTitle .
}
GROUP BY ?category ?categoryTitle
ORDER BY DESC(?detectionCount)

# Query 5.4: Comorbidity patterns (most common co-occurrences)
# Purpose: Identify frequent condition pairs
SELECT ?category1 ?category2 (COUNT(*) AS ?coOccurrenceCount)
WHERE {
  ?illnessSet miao:hasMentalIllness ?illness1, ?illness2 .
  
  ?illness1 miao:referredToMentalIllnessCategory ?category1 ;
            miao:refersToSample ?sample .
  
  ?illness2 miao:referredToMentalIllnessCategory ?category2 ;
            miao:refersToSample ?sample .
  
  FILTER(?illness1 != ?illness2)
  FILTER(STR(?category1) < STR(?category2))  # Avoid duplicates
}
GROUP BY ?category1 ?category2
HAVING(?coOccurrenceCount > 0)
ORDER BY DESC(?coOccurrenceCount)

# Query 5.5: Model performance ranking
# Purpose: Leaderboard of best-performing models
SELECT ?implementation ?model
       (AVG(?accuracy) AS ?avgAccuracy) 
       (AVG(?f1) AS ?avgF1)
WHERE {
  ?run mls:executes ?implementation ;
       mls:hasOutput ?model, ?eval1 .
  
  ?eval1 mls:specifiedBy ex2:predictiveAccuracy ;
         mls:hasValue ?accuracy .
  
  OPTIONAL {
    ?run mls:hasOutput ?eval2 .
    ?eval2 mls:specifiedBy ex2:f1Score ;
           mls:hasValue ?f1 .
  }
}
GROUP BY ?implementation ?model
ORDER BY DESC(?avgAccuracy)

# Query 5.6: Temporal trends in detection
# Purpose: Track annotation activity over time
SELECT (SUBSTR(?date, 1, 7) AS ?month) (COUNT(?detection) AS ?detectionCount)
WHERE {
  ?detection a ?detectionType ;
             dcterms:created ?date .
  
  FILTER(?detectionType IN (miao:ManualMentalIllnessesDetection, 
                            miao:AutomaticMentalIllnessesDetection))
}
GROUP BY (SUBSTR(?date, 1, 7))
ORDER BY ?month

# Query 5.7: Data source usage statistics
# Purpose: Track which datasets are most utilized
SELECT ?inputData ?dataLabel (COUNT(?detection) AS ?usageCount)
WHERE {
  ?detection miao:hasInputData ?inputData .
  ?inputData rdfs:label ?dataLabel .
}
GROUP BY ?inputData ?dataLabel
ORDER BY DESC(?usageCount)